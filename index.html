<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ultimate Ransomware Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/dracula.min.css">
    <style>
        :root {
            --dark-bg: #1a1a2e; --container-bg: #2a2a4a; --section-bg: #333355; --interactive-bg: #444466;
            --accent-blue: #8be9fd; --accent-purple: #bd93f9; --accent-pink: #ff79c6; --accent-green: #50fa7b;
            --accent-yellow: #f1fa8c; --accent-red: #ff5555; --text-light: #e0e0e0; --text-dark: #282a36;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        body { font-family: 'Roboto', sans-serif; background-color: var(--dark-bg); color: var(--text-light); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); padding: 40px; max-width: 900px; width: 100%; margin: 40px 0; }
        .centered-page { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 60vh; animation: fadeIn 0.5s ease-out; }
        h1 { font-size: 2.5em; color: var(--accent-blue); margin-bottom: 20px; }
        h2 { font-size: 2em; color: var(--accent-blue); border-bottom: 2px solid var(--interactive-bg); padding-bottom: 15px; margin-bottom: 25px; }
        h3 { font-size: 1.5em; color: var(--accent-blue); }
        h4 { font-size: 1.2em; color: var(--accent-purple); text-align: left; margin-top: 0; border-bottom: 1px solid var(--interactive-bg); padding-bottom: 10px; }
        p { line-height: 1.7; font-size: 1.1em; }
        .section { display: none; padding: 30px; background-color: var(--section-bg); border-radius: 8px; margin-top: 25px; animation: fadeIn 0.5s ease-out; }
        .interactive-element { background-color: var(--interactive-bg); border-radius: 8px; padding: 20px; margin-top: 20px; }
        .decision-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .btn { background-color: #6272a4; color: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 1.1em; transition: all 0.3s ease; text-align: left; display: flex; align-items: center; gap: 15px; font-weight: 700; }
        .btn:hover { background-color: #7a8ab9; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .btn .btn-text { flex-grow: 1; }
        .btn small { display: block; font-size: 0.85em; opacity: 0.8; margin-top: 5px; font-weight: 400; }
        .btn-start, .btn-continue { font-size: 1.3em; font-weight: bold; text-align: center; background-color: var(--accent-green); color: var(--text-dark); justify-content: center; }
        #intermissionSection .metric-change { font-size: 1.2em; margin: 15px 0; display: flex; align-items: center; gap: 10px; }
        .metric-change .positive { color: var(--accent-green); }
        .metric-change .negative { color: var(--accent-red); }
        #statusBar { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; background-color: var(--text-dark); padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #6272a4; }
        #statusBar .metric { text-align: center; font-size: 0.9em; }
        #statusBar .metric .value { font-size: 1.3em; font-weight: bold; color: var(--accent-yellow); }
        .final-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; width: 100%; max-width: 850px; }
        .metric-card { background-color: var(--section-bg); padding: 25px; border-radius: 8px; text-align: center; border: 1px solid var(--interactive-bg); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px; }
        .metric-card:hover { transform: scale(1.05); border-color: var(--accent-blue); }
        .metric-card .icon { font-size: 2.5em; color: var(--accent-blue); margin-bottom: 10px; }
        .metric-card .label { font-size: 1.1em; margin-bottom: 5px; color: var(--text-light); }
        .metric-card .value { font-size: 1.8em; font-weight: bold; color: var(--accent-yellow); }
        .code-block, .siem-log-viewer, .slack-chat { background-color: var(--text-dark); border: 1px solid #6272a4; border-radius: 8px; padding: 20px; margin-top: 15px; white-space: pre-wrap; word-break: break-all; font-family: 'Consolas', monospace; }
        .learning-note { background-color: var(--text-dark); border-left: 5px solid var(--accent-blue); padding: 20px; border-radius: 8px; margin-top: 30px; }
        .scenario-image { width: 100%; max-width: 500px; margin: 25px auto; display: block; border-radius: 8px; border: 1px solid var(--interactive-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .network-node { position: absolute; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.9em; font-weight: bold; color: white; cursor: help; z-index: 10; border: 2px solid white; text-shadow: 0 0 5px black; }
        .network-node.infected { background-color: var(--accent-red); animation: pulse 1s infinite alternate; }
        .network-node.isolated { background-color: var(--accent-yellow); color: var(--text-dark); border-color: var(--text-dark); animation: none; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
        #finalSection { text-align: center; }
        #performance-badge-container { margin: 25px 0; }
        #performance-badge { padding: 12px 30px; font-size: 1.8em; font-weight: bold; border-radius: 50px; display: inline-block; color: var(--text-dark); box-shadow: 0 5px 20px rgba(0,0,0,0.4); transition: transform 0.3s ease; }
        #performance-badge:hover { transform: scale(1.05); }
        .post-crisis-layout { display: grid; grid-template-columns: 1fr; gap: 30px; text-align: left; margin-top: 40px; width: 100%; }
        @media (min-width: 800px) { .post-crisis-layout { grid-template-columns: 1fr 1fr; } }
        .event-timeline, .strategic-debrief { background-color: var(--interactive-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--section-bg); margin-top: 20px; }
        .event-timeline h3, .strategic-debrief h3 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid var(--section-bg); color: var(--accent-blue); display: flex; align-items: center; gap: 10px; }
        .event-timeline ul { list-style-type: none; padding-left: 0; margin: 15px 0 0 0; }
        .event-timeline li { position: relative; padding: 5px 0 15px 35px; border-left: 2px solid var(--section-bg); font-size: 0.95em; }
        .event-timeline li:last-child { border-left: none; }
        .event-timeline li::before { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--accent-green); position: absolute; left: -12px; top: 5px; background-color: var(--dark-bg); width: 22px; height: 22px; border-radius: 50%; text-align: center; line-height: 22px; font-size: 0.8em; border: 2px solid var(--section-bg); }
        .event-timeline li.positive::before { content: '\f00c'; color: var(--accent-green); }
        .event-timeline li.negative::before { content: '\f00d'; color: var(--accent-red); }
        .event-timeline li.neutral::before { content: '\f05a'; color: var(--accent-blue); }
        .event-timeline li .decision-title { font-weight: bold; color: var(--accent-purple); display: block; margin-bottom: 4px; }
        #strategic-debrief-content p { font-size: 1em; margin-bottom: 15px; }
        #score-breakdown { list-style: none; padding: 0; margin-top: 15px; text-align: left; }
        #score-breakdown li { padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 1.05em; display: flex; justify-content: space-between; }
        #score-breakdown .score-plus { background-color: rgba(80, 250, 123, 0.1); border-left: 3px solid var(--accent-green); }
        #score-breakdown .score-minus { background-color: rgba(255, 85, 85, 0.1); border-left: 3px solid var(--accent-red); }
        #score-breakdown .score-neutral { background-color: rgba(139, 233, 253, 0.1); border-left: 3px solid var(--accent-blue); }
        #score-breakdown .score-value { font-weight: bold; }
        .lb-overlay{ display:none; position:fixed; inset:0; background: rgba(10,10,25,.7); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); z-index:9999; align-items:center; justify-content:center; padding:20px; animation: fadeIn 0.3s ease-out; }
        .lb-modal{ background: linear-gradient(180deg, #2a2a4a 0%, #1f1f36 100%); color: var(--text-light); width:100%; max-width: 760px; border-radius:14px; padding:22px 22px 16px; border:1px solid rgba(255,255,255,.08); box-shadow: 0 18px 50px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04); }
        .lb-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
        .lb-title{ display:flex; align-items:center; gap:10px; font-size:1.25em; font-weight:800; letter-spacing:.2px; color: var(--accent-yellow); }
        .lb-title i{ filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
        .lb-tablewrap{ margin-top:10px; max-height: 60vh; overflow:auto; border:1px solid var(--interactive-bg); border-radius:10px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.02); }
        table.lb-table{ width:100%; border-collapse:collapse; font-size:.97em; }
        table.lb-table th, table.lb-table td{ padding:10px 12px; text-align:left; }
        table.lb-table thead th{ position: sticky; top:0; z-index:1; background:#1f1f36; color:#e9e9ff; border-bottom: 1px solid #3b3b66; font-weight:700; letter-spacing:.3px; }
        table.lb-table tbody td{ border-bottom:1px solid rgba(255,255,255,.06); color:#e9e9f5; }
        table.lb-table tbody tr:hover{ background-color: rgba(255,255,255,.045); }
        table.lb-table tbody tr:nth-child(1){ background: linear-gradient(90deg, rgba(255,215,0,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(1) td:first-child::after{ content:" 🥇"; }
        table.lb-table tbody tr:nth-child(2){ background: linear-gradient(90deg, rgba(192,192,192,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(2) td:first-child::after{ content:" 🥈"; }
        table.lb-table tbody tr:nth-child(3){ background: linear-gradient(90deg, rgba(205,127,50,.18), transparent 65%); }
        table.lb-table tbody tr:nth-child(3) td:first-child::after{ content:" 🥉"; }
        .lb-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:14px; }
        .lb-close, .lb-refresh{ border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease; }
        .lb-refresh{ background: var(--accent-blue); color:#0c1130; }
        .lb-close{ background: #3d3d60; color:#fff; }
        .lb-refresh:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(139,233,253,.22); }
        .lb-close:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.35); }
        @media (max-width: 420px){ .lb-title{ font-size:1.05em; } table.lb-table th, table.lb-table td{ padding:9px 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="introSection" class="centered-page">
            <h1><i class="fa-solid fa-shield-virus"></i> Ransomware Simulation</h1>
            <p>Taking on the role of a cybersecurity analyst, you will respond to an evolving ransomware attack. The decisions you make will determine the fate of the company. Are you ready?</p>
            <img src="giris.png" alt="Cybersecurity visual representing a ransomware attack" class="scenario-image">
            <div class="interactive-element" style="margin-top: 30px; text-align: left;">
                <h4><i class="fa-solid fa-people-group"></i> Simulation Roles </h4>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 10px;"><i class="fa-solid fa-user-shield" style="color:var(--accent-green); margin-right: 10px;"></i> <strong>You (Cybersecurity Analyst):</strong> You are the brain of the incident response team. You will analyze the threat, make critical decisions, and stop the spread.</li>
                    <li style="margin-bottom: 10px;"><i class="fa-solid fa-user" style="color:var(--accent-blue); margin-right: 10px;"></i> <strong>Ms. Elif (Human Resources Employee):</strong> The first victim of the attack, but plays a critical role with her early warning.</li>
                    <li style="margin-bottom: 10px;"><i class="fa-solid fa-handshake" style="color:var(--accent-purple); margin-right: 10px;"></i> <strong>The Board (CEO, CFO, Legal):</strong> The fate of the company is in their hands. They need your guidance to manage financial, reputational, and legal risks.</li>
                    <li style="margin-bottom: 10px;"><i class="fa-solid fa-mask" style="color:var(--accent-red); margin-right: 10px;"></i> <strong>Cybercriminals (Threat Actors):</strong> Your relentless enemies. Their goals are financial gain and chaos.</li>
                </ul>
            </div>
            <button class="btn btn-start" id="startButton"><i class="fa-solid fa-play"></i> Start Simulation</button>
        </div>

        <div id="intermissionSection" class="centered-page" style="display: none;">
            <h2 id="intermissionTitle"></h2>
            <p id="intermissionText" style="max-width: 600px;"></p>
            <div class="interactive-element" style="width: 100%; max-width: 500px;">
                <h4>Decision Impacts</h4><div id="intermissionMetrics"></div>
            </div>
            <div class="interactive-element" style="width: 100%; max-width: 500px; border-left-color: var(--accent-blue); margin-top: 20px;">
                <h4>Strategic Assessment</h4><p id="strategicText" style="font-size: 1em;"></p>
            </div>
            <button class="btn btn-continue" id="continueButton" style="margin-top: 30px;"><i class="fa-solid fa-forward"></i> Continue</button>
        </div>

        <div id="gameContainer" style="display: none;">
            <div id="statusBar">
                <div class="metric"><span><i class="fa-solid fa-computer"></i> Affected Systems</span><div class="value" id="status-affectedSystems">1</div></div>
                <div class="metric"><span><i class="fa-solid fa-hand-holding-dollar"></i> Financial Loss</span><div class="value" id="status-financialLoss">$0</div></div>
                <div class="metric"><span><i class="fa-solid fa-database"></i> Data Loss</span><div class="value" id="status-dataLoss">0%</div></div>
                <div class="metric"><span><i class="fa-solid fa-building-shield"></i> Reputation Score</span><div class="value" id="status-reputation">100</div></div>
                <div class="metric" id="status-timer"><span><i class="fa-solid fa-clock"></i> Time Remaining</span><div class="value">03:00</div></div>
            </div>
            <div id="game-content"></div>
        </div>
    </div>

    <div class="lb-overlay" id="leaderboardOverlay" role="dialog" aria-modal="true" aria-labelledby="lbTitle">
        <div class="lb-modal">
            <div class="lb-header">
                <h2 id="lbTitle" class="lb-title"><i class="fa-solid fa-trophy"></i> Leaderboard</h2>
                <span class="lb-sub">Ransomware Simulation Top Scores</span>
            </div>
            <div class="lb-tablewrap">
                <table class="lb-table" id="leaderboardTable">
                    <thead>
                        <tr><th>#</th><th>Name</th><th>Score</th><th>Date</th></tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr><td colspan="4">Loading…</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="lb-actions">
                <button class="lb-refresh" id="lbRefreshBtn"><i class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                <button class="lb-close" id="lbCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const game = {
                score: { affectedSystems: 1, financialLoss: 0, dataLoss: 0, reputation: 100 },
                state: { infected: ['hr'], isolated: [], currentSection: 0, decisionHistory: [] },
                elements: {},
                timer: { total: 180, remaining: 180, intervalId: null, running: false },
                decisionInfo: {
                    's1-isolate': { title: "Quick Response!", text: "By instantly isolating the computer, you slowed the direct spread of the attack across the network. This proactive move bought you valuable time.", strat: "Proactive isolation is the best first step to prevent lateral movement and buy time.", changes: { financialLoss: 2500, newIsolated: ['hr'], reputation: 5 }, impact: 'Positive' },
                    's1-observe': { title: "Critical Delay!", text: "Your decision to wait allowed the malware to establish a foothold on the network and infect the File Server. The crisis is now larger.", strat: "With fast-spreading threats like ransomware, waiting to observe often leads to disaster. Containment at first contact is essential.", changes: { financialLoss: 25000, reputation: -10, affectedSystems: 1, newInfected: ['fs'] }, impact: 'Negative' },
                    's2-segment': { title: "Smart Defense!", text: "Segmenting critical servers from the network prevented the attack from reaching your most valuable asset: the backup server.", strat: "Network segmentation is a vital technique for damage control. It protects the most valuable assets by restricting the attacker's movement.", changes: { financialLoss: 75000, reputation: 5, newIsolated: ['bk'] }, impact: 'Positive' },
                    's2-shutdown': { title: "Radical Solution!", text: "Shutting down all servers stopped the spread cold, but company operations came to a complete halt.", strat: "This method is like 'dropping the hammer.' It's effective but has a devastating impact on business continuity. It should generally be considered a last resort.", changes: { financialLoss: 200000, reputation: -15, newIsolated: ['fs', 'db', 'bk'] }, impact: 'Negative' },
                    's3-restore': { title: "Principled Decision!", text: "You did the right thing by refusing to pay the ransom and restoring from backup. However, the 1 week of data loss and the restoration process were costly.", strat: "Not paying the ransom is important to deter cybercriminals. Reliable and up-to-date backups are a company's greatest insurance policy.", changes: { financialLoss: 250000, reputation: 15, dataLoss: 7 }, impact: 'Positive' },
                    's3-pay': { title: "Risky Gamble!", text: "You paid the ransom. Luckily, the attackers kept their word. However, this payment funded the cybercrime ecosystem and damaged the company's reputation.", strat: "Paying a ransom never guarantees that data will be recovered or not leaked. It also makes the company a target for future attacks.", changes: { financialLoss: 2500000, reputation: -40 }, impact: 'Negative' },
                    's4-cut': { title: "Critical Intervention!", text: "You immediately cut off the data exfiltration, preventing further theft of customer data. This saved the company from legal penalties and a greater loss of reputation.", strat: "When data exfiltration is detected, the first priority is to stop the bleeding. Every second counts.", changes: { reputation: 10, financialLoss: 25000 }, impact: 'Positive' },
                    's4-honeypot': { title: "Advanced Tactic!", text: "Redirecting the attacker to a honeypot provided valuable intelligence about their tactics. However, some more data was leaked during this process.", strat: "Using a honeypot is an advanced defense technique but carries risks. You must be sure you can keep the situation under control.", changes: { financialLoss: 50000, reputation: -5, dataLoss: 5 }, impact: 'Negative' },
                },

                setup() {
                    this.elements = {
                        intro: document.getElementById('introSection'), game: document.getElementById('gameContainer'), gameContent: document.getElementById('game-content'),
                        startButton: document.getElementById('startButton'), intermission: document.getElementById('intermissionSection'),
                        intermissionTitle: document.getElementById('intermissionTitle'), intermissionText: document.getElementById('intermissionText'),
                        intermissionMetrics: document.getElementById('intermissionMetrics'), strategicText: document.getElementById('strategicText'),
                        continueButton: document.getElementById('continueButton'),
                        statusBar: { 
                            affectedSystems: document.getElementById('status-affectedSystems'), 
                            financialLoss: document.getElementById('status-financialLoss'), 
                            dataLoss: document.getElementById('status-dataLoss'), 
                            reputation: document.getElementById('status-reputation'),
                            timer: document.getElementById('status-timer').querySelector('.value')
                        },
                         leaderboard: {
                            overlay: document.getElementById('leaderboardOverlay'),
                            body: document.getElementById('leaderboardBody'),
                            btnClose: document.getElementById('lbCloseBtn'),
                            btnRefresh: document.getElementById('lbRefreshBtn'),
                            btnOpen: null 
                        }
                    };
                    this.loadGameHTML();
                    this.attachListeners();
                },

                attachListeners() {
                    this.elements.startButton.addEventListener('click', () => {
                        this.elements.intro.style.display = 'none';
                        this.elements.game.style.display = 'block';
                        this.startGlobalTimer();
                        this.showSection(1);
                        this.updateState();
                    });
                    this.elements.gameContent.addEventListener('click', (e) => {
                        const button = e.target.closest('.btn[data-decision]');
                        if (button) this.handleDecision(button.dataset.decision, parseInt(button.dataset.next, 10), button);
                    });
                    this.elements.continueButton.addEventListener('click', () => {
                        const nextSection = parseInt(this.elements.continueButton.dataset.next, 10);
                        this.elements.intermission.style.display = 'none';
                        if (nextSection > 4) {
                           this.showFinalReport();
                        } else {
                            this.elements.game.style.display = 'block';
                            this.showSection(nextSection);
                        }
                    });
                     this.elements.leaderboard.btnClose?.addEventListener('click', () => this.closeLeaderboard());
                     this.elements.leaderboard.btnRefresh?.addEventListener('click', () => this.loadLeaderboard());
                     this.elements.leaderboard.overlay.addEventListener('click', (e) => {
                         if (e.target === this.elements.leaderboard.overlay) this.closeLeaderboard();
                     });
                },
                
                handleDecision(decision, nextSection, button) {
                    button.closest('.decision-buttons').querySelectorAll('.btn').forEach(btn => btn.disabled = true);
                    const info = this.decisionInfo[decision];
                    if (!info) return;

                    this.score.financialLoss += info.changes.financialLoss || 0;
                    this.score.reputation += info.changes.reputation || 0;
                    this.score.dataLoss += info.changes.dataLoss || 0;
                    this.score.affectedSystems += info.changes.affectedSystems || 0;
                    if (info.changes.newInfected) this.state.infected.push(...info.changes.newInfected);
                    if (info.changes.newIsolated) this.state.isolated.push(...info.changes.newIsolated);
                    
                    this.state.decisionHistory.push({ id: decision, title: info.title, impactType: info.impact });
                    this.updateState();
                    this.showIntermission(info.title, info.text, info.strat, info.changes, nextSection);
                },

                showIntermission(title, text, strat, changes, next) {
                    this.elements.intermissionTitle.textContent = title;
                    this.elements.intermissionText.textContent = text;
                    this.elements.strategicText.textContent = strat;
                    
                    let metricsHTML = '';
                    const formatChange = (label, value, unit, icon, isPositive) => `<div class="metric-change ${isPositive ? 'positive' : 'negative'}"><i class="fa-solid ${icon}"></i> ${label}: <i class="fa-solid fa-arrow-${isPositive ? 'up' : 'down'}-long"></i> ${Math.abs(value).toLocaleString('en-US')}${unit}</div>`;

                    if (changes.financialLoss) metricsHTML += formatChange('Financial Loss', changes.financialLoss, '$', 'fa-sack-xmark', false);
                    if (changes.dataLoss) metricsHTML += formatChange('Data Loss', changes.dataLoss, '%', 'fa-database', false);
                    if (changes.reputation) metricsHTML += formatChange('Reputation Score', Math.abs(changes.reputation), '', 'fa-building-shield', changes.reputation > 0);
                    if (changes.affectedSystems) metricsHTML += formatChange('Affected System', changes.affectedSystems, '', 'fa-computer', false);
                    if (metricsHTML === '') metricsHTML = '<p style="text-align: center; font-size: 1.1em; opacity: 0.8;">This decision had no direct impact on the metrics.</p>';

                    this.elements.intermissionMetrics.innerHTML = metricsHTML;
                    this.elements.continueButton.dataset.next = next;
                    this.elements.game.style.display = 'none';
                    this.elements.intermission.style.display = 'flex';
                },

                updateStatusBar() {
                    const s = this.score;
                    this.elements.statusBar.affectedSystems.textContent = s.affectedSystems;
                    this.elements.statusBar.financialLoss.textContent = `$${s.financialLoss.toLocaleString('en-US')}`;
                    this.elements.statusBar.dataLoss.textContent = `${s.dataLoss}%`;
                    this.elements.statusBar.reputation.textContent = Math.max(0, s.reputation);
                },

                showSection(index) {
                     this.state.currentSection = index;
                     this.elements.sections.forEach((section, i) => { section.style.display = (i === index - 1) ? 'block' : 'none'; });
                     if (index === 5) this.showFinalReport();
                },
                
                showFinalReport() {
                    this.stopGlobalTimer();
                    this.elements.intro.style.display = 'none';
                    this.elements.intermission.style.display = 'none';
                    this.elements.game.style.display = 'block';
                    document.getElementById('statusBar').style.display = 'none';
                    this.elements.sections.forEach(s => s.style.display = 'none');

                    const finalSection = document.getElementById('finalSection');
                    finalSection.style.display = 'flex';

                    // --- SCORING SYSTEM ---
                    let scoreBreakdown = {};
                    let totalScore = 50; 
                    scoreBreakdown['Starting Score'] = { value: 50, class: 'score-neutral' };

                    let decisionQualityScore = 0;
                    this.state.decisionHistory.forEach(decision => {
                        if (decision.impactType === 'Negative') decisionQualityScore -= 10;
                        else if (decision.impactType === 'Positive') decisionQualityScore += 10;
                    });
                    totalScore += decisionQualityScore;
                    scoreBreakdown['Decision Quality'] = { value: decisionQualityScore, class: decisionQualityScore >= 0 ? 'score-plus' : 'score-minus' };
                    
                    const paidRansom = this.state.decisionHistory.some(d => d.id === 's3-pay');
                    if(paidRansom) {
                        totalScore -= 25;
                        scoreBreakdown['Ransom Payment Penalty'] = { value: -25, class: 'score-minus' };
                    }

                    let financialScore = 0;
                    if (this.score.financialLoss < 100000) financialScore = 10;
                    else if (this.score.financialLoss > 500000) financialScore = -15;
                    totalScore += financialScore;
                    scoreBreakdown['Financial Management'] = { value: financialScore, class: financialScore > 0 ? 'score-plus' : financialScore < 0 ? 'score-minus' : 'score-neutral' };

                    let dataLossScore = 0;
                    if (this.score.dataLoss === 0) dataLossScore = 15;
                    else if (this.score.dataLoss > 5) dataLossScore = -10;
                    totalScore += dataLossScore;
                    scoreBreakdown['Data Integrity'] = { value: dataLossScore, class: dataLossScore > 0 ? 'score-plus' : 'score-minus' };

                    if (this.timer.remaining > 60) {
                        totalScore += 10;
                        scoreBreakdown['Quick Response Bonus'] = { value: 10, class: 'score-plus' };
                    }
                    totalScore = Math.round(Math.max(0, Math.min(100, totalScore)));
                    // --- END OF SCORING ---

                    let badgeInfo = {};
                    if (totalScore >= 90) badgeInfo = { text: 'CYBER WARDEN', color: 'var(--accent-green)' };
                    else if (totalScore >= 70) badgeInfo = { text: 'SYSTEM DEFENDER', color: 'var(--accent-blue)' };
                    else if (totalScore >= 45) badgeInfo = { text: 'DAMAGE CONTROL', color: 'var(--accent-yellow)' };
                    else badgeInfo = { text: 'SYSTEM MELTDOWN', color: 'var(--accent-red)' };

                    document.getElementById('performance-badge').textContent = badgeInfo.text;
                    document.getElementById('performance-badge').style.backgroundColor = badgeInfo.color;

                    document.getElementById('finalMetricsContainer').innerHTML = `
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-file-invoice-dollar"></i></div><div class="label">Final Score</div><div class="value">${totalScore}/100</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-building-shield"></i></div><div class="label">Reputation Score</div><div class="value">${Math.max(0, this.score.reputation)}/100</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-hand-holding-dollar"></i></div><div class="label">Financial Loss</div><div class="value">$${this.score.financialLoss.toLocaleString('en-US')}</div></div>
                        <div class="metric-card"><div class="icon"><i class="fa-solid fa-database"></i></div><div class="label">Data Loss</div><div class="value">${this.score.dataLoss}%</div></div>
                    `;

                    document.getElementById('decision-timeline-list').innerHTML = this.state.decisionHistory.map(decision => 
                        `<li class="${decision.impactType.toLowerCase()}"><span class="decision-title">${this.decisionInfo[decision.id].title}</span></li>`
                    ).join('');
                    
                    document.getElementById('score-breakdown').innerHTML = Object.entries(scoreBreakdown).map(([key, item]) => 
                        `<li class="${item.class}"><span>${key}</span><span class="score-value">${item.value >= 0 ? '+' : ''}${item.value} Points</span></li>`
                    ).join('');
                    
                    let debriefHTML = '';
                    if (totalScore >= 70) {
                        debriefHTML = `<p><strong>Excellent Crisis Management:</strong> You contained the attack in its early stages, prevented its spread with correct decisions, and saved the company from a major disaster. By not paying the ransom, you took the right stance against cybercrime.</p>`;
                    } else if (totalScore >= 45) {
                        debriefHTML = `<p><strong>A Tough Fight:</strong> You managed the crisis, but some delays or risky decisions caused both financial and operational damage to the company. This incident provides critical lessons for reviewing our backup and network segmentation strategies.</p>`;
                    } else {
                        debriefHTML = `<p><strong>Serious Consequences:</strong> Critical errors in the crisis management process allowed the ransomware to cause significant damage. A slow response or the decision to pay the ransom (if made) placed a heavy burden on the company, both financially and reputationally.</p>`;
                    }
                    document.getElementById('strategic-debrief-content').innerHTML = debriefHTML;

                    this.saveLeaderboard(totalScore);
                },

                updateState() { this.updateStatusBar(); this.updateSiemLogs(); },
                updateSiemLogs() {
                    if (!this.elements.siemLogs2) return;
                    let html = `<div><span style="color:var(--accent-yellow);">[09:45:12] WARNING: Abnormal PowerShell activity from HR-PC-ELIF (192.168.1.112).</span></div>`;
                    if (this.state.infected.includes('fs')) {
                        html += `<div><span style="color:var(--accent-red); font-weight:bold;">[10:05:11] CRITICAL: Mimikatz (credential theft) activity on FileServer (192.168.1.50)!</span></div>`;
                    }
                    if (this.state.infected.includes('db')) {
                        html += `<div><span style="color:var(--accent-red); font-weight:bold;">[10:15:40] CRITICAL: Abnormal file encryption activity on DB-Server (192.168.1.70)!</span></div>`;
                    }
                    if (!this.state.infected.includes('fs') && !this.state.infected.includes('db')) {
                        html += `<div><span style="color:var(--accent-green);">[10:00:00] No other suspicious activity on the server network for now.</span></div>`;
                    }
                    this.elements.siemLogs2.innerHTML = html;
                },

                startGlobalTimer() {
                    if (this.timer.running) return;
                    this.timer.running = true;
                    this.timer.intervalId = setInterval(() => {
                        this.timer.remaining--;
                        this.updateTimerUI();
                        if (this.timer.remaining <= 0) {
                            this.stopGlobalTimer();
                            alert("Time is up! Generating report.");
                            this.showFinalReport();
                        }
                    }, 1000);
                },
                stopGlobalTimer() { clearInterval(this.timer.intervalId); this.timer.running = false; },
                updateTimerUI() {
                    const m = String(Math.floor(this.timer.remaining / 60)).padStart(2, '0');
                    const s = String(this.timer.remaining % 60).padStart(2, '0');
                    if (this.elements.statusBar.timer) this.elements.statusBar.timer.textContent = `${m}:${s}`;
                },

                openLeaderboard() { this.elements.leaderboard.overlay.style.display = 'flex'; this.loadLeaderboard(); },
                closeLeaderboard() { this.elements.leaderboard.overlay.style.display = 'none'; },
                async saveLeaderboard(finalScore) {
                    let name = localStorage.getItem('playerName') || prompt("Enter your name for the leaderboard:", "Anonymous") || "Anonymous";
                    localStorage.setItem('playerName', name);
                    const payload = { scenario: 'v4-ransomware', name: name.slice(0, 40), score: finalScore, timestamp: new Date().toISOString() };
                    try {
                        const res = await fetch('/api/score', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!res.ok) throw new Error('API request failed');
                    } catch(e) {
                        const key = 'leaderboard-v4-ransomware';
                        const arr = JSON.parse(localStorage.getItem(key) || '[]');
                        arr.push(payload);
                        localStorage.setItem(key, JSON.stringify(arr.sort((a,b)=> b.score - a.score).slice(0,100)));
                    }
                },
                async loadLeaderboard() {
                    const tbody = this.elements.leaderboard.body;
                    tbody.innerHTML = `<tr><td colspan="4">Loading…</td></tr>`;
                    let rows = [];
                    try {
                        const res = await fetch('/api/leaderboard?scenario=v4-ransomware');
                        if (!res.ok) throw new Error('API request failed');
                        rows = await res.json();
                    } catch(e) {
                        rows = JSON.parse(localStorage.getItem('leaderboard-v4-ransomware') || '[]');
                    }
                    if (!rows.length) {
                        tbody.innerHTML = `<tr><td colspan="4">No entries yet.</td></tr>`;
                        return;
                    }
                    tbody.innerHTML = rows.sort((a,b)=> b.score - a.score).slice(0,50).map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.score}</td><td>${new Date(r.timestamp).toLocaleString('en-US')}</td></tr>`).join('');
                },

                loadGameHTML() {
                    const gameHTMLContent = `
                        <div id="section1" class="section">
                            <div id="s1-part1">
                                <h2><i class="fa-solid fa-envelope-open-text"></i> Chapter 1: The Unexpected Guest</h2>
                                <p>Ms. Elif from the Human Resources department opens an email attachment named "CV_Resume.docx". She reports that the file seemed harmless, but her computer has slowed down.</p>
                                <img src="elif_eposta.png" alt="Employee opening an email" class="scenario-image">
                                <button class="btn btn-continue" style="margin: 20px auto 0;" onclick="document.getElementById('s1-part1').style.display='none'; document.getElementById('s1-part2').style.display='block';"><i class="fa-solid fa-arrow-right"></i> Start Analysis</button>
                            </div>
                            <div id="s1-part2" style="display:none; animation: fadeIn 0.5s ease-out;">
                                 <div class="interactive-element"><h4><i class="fa-solid fa-file-waveform"></i> Initial Findings</h4>
                                    <p>Analysis of the email and file reveals that it executed an encoded PowerShell command hidden within the document.</p>
                                    <img src="ilk_bulgular.png" alt="Malicious code analysis" class="scenario-image">
                                    <div class="code-block"><pre><code class="language-powershell">powershell.exe -NoP -NonI -Exec Bypass -EncodedCommand JABjAGwAaQBlAG4AdA....</code></pre></div>
                                </div>
                                <div class="decision-buttons">
                                    <button class="btn critical" data-decision="s1-isolate" data-next="2"><i class="fa-solid fa-person-running"></i><div class="btn-text">Option A: Immediately isolate Ms. Elif's computer from the network.<small>Immediate action can prevent the spread.</small></div></button>
                                    <button class="btn" data-decision="s1-observe" data-next="2"><i class="fa-solid fa-magnifying-glass"></i><div class="btn-text">Option B: Monitor the suspicious activity to gather more evidence.<small>Taking action without certainty could halt business.</small></div></button>
                                </div>
                                <div class="learning-note"><strong>Learning Note:</strong> Phishing emails are the most common entry point for ransomware. Quick isolation is key to preventing lateral movement.</div>
                            </div>
                        </div>
                        
                        <div id="section2" class="section">
                            <h2><i class="fa-solid fa-network-wired"></i> Chapter 2: Chain Reaction</h2>
                            <p>The malware has started to spread across the network. The attackers are moving between servers using compromised credentials.</p>
                             <div class="interactive-element">
                                <h4><i class="fa-solid fa-map-location-dot"></i> Network Map</h4>
                                <div id="network-map-container-2">
                                    <img src="network_map_bg.png" alt="Network Map" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; opacity: 0.4;">
                                </div>
                            </div>
                             <div class="interactive-element"><h4><i class="fa-solid fa-terminal"></i> SIEM Logs</h4><div class="siem-log-viewer" id="siemLogs2"></div></div>
                            <div class="decision-buttons">
                                <button class="btn" data-decision="s2-segment" data-next="3"><i class="fa-solid fa-diagram-project"></i><div class="btn-text">Option A: Isolate critical servers by segmenting them from the network.<small>Limits the damage but is a complex operation.</small></div></button>
                                <button class="btn" data-decision="s2-shutdown" data-next="3"><i class="fa-solid fa-power-off"></i><div class="btn-text">Option B: Shut down all affected servers to completely stop the spread.<small>Effective, but completely halts operations.</small></div></button>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Network segmentation is a critical defense mechanism that prevents an attacker from accessing the entire network.</div>
                        </div>
                        
                        <div id="section3" class="section">
                            <h2><i class="fa-solid fa-users-viewfinder"></i> Chapter 3: The War Room and the Ransom Note</h2>
                            <p>Files have begun to encrypt, and a ransom note has appeared on the servers. The attackers are demanding $250,000 and threatening to leak the data. Management is in a panic.</p>
                             <img src="yonetim_toplantisi.png" alt="War room meeting" class="scenario-image">
                            <div class="interactive-element"><h4><i class="fa-solid fa-comments"></i> Management Emergency Channel</h4><div class="slack-chat"><div><span style="font-weight:bold; color:var(--accent-pink);">CEO:</span> Our reputation will be ruined! Is customer data safe? End this crisis now!</div><div style="margin-top: 10px;"><span style="font-weight:bold; color:var(--accent-yellow);">CFO:</span> $250,000! We'll go bankrupt if we pay that. Can't we restore from our backups?</div><div style="margin-top: 10px;"><span style="font-weight:bold; color:var(--accent-blue);">Legal Counsel:</span> Paying the ransom could mean financing illegal activities and may have legal consequences.</div></div></div>
                            <div class="decision-buttons">
                                <button class="btn" data-decision="s3-restore" data-next="4"><i class="fa-solid fa-clock-rotate-left"></i><div class="btn-text">Option A: Do not pay the ransom. Restore from clean backups that are a week old.<small>There will be data loss, but no money goes to criminals.</small></div></button>
                                <button class="btn critical" data-decision="s3-pay" data-next="4"><i class="fa-solid fa-money-bill-wave"></i><div class="btn-text">Option B: Don't risk the company's future, pay the ransom.<small>Could be a quick solution, but there's no guarantee and it's very costly.</small></div></button>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> The decision to pay a ransom is not just a technical one. It has financial, legal, and ethical dimensions.</div>
                        </div>
                        
                        <div id="section4" class="section">
                            <h2><i class="fa-solid fa-user-secret"></i> Chapter 4: The Hidden Threat: Data Exfiltration</h2>
                            <p>While your team deals with the encrypted files, threat hunting tools have uncovered a more sinister danger: while encrypting files, the attackers are also actively exfiltrating data from the customer database (Double Extortion)!</p>
                            <img src="siem_ekrani.png" alt="SIEM log screen" class="scenario-image">
                            <div class="interactive-element"><h4><i class="fa-solid fa-terminal"></i> SIEM Logs</h4><div class="siem-log-viewer"><div style="color:var(--accent-red); font-weight: bold;">[11:45:10] CRITICAL: Encrypted and continuous data stream from DB-Server (192.168.1.70) to an unknown external IP (81.25.11.92) detected!</div></div></div>
                            <div class="decision-buttons">
                                <button class="btn critical" data-decision="s4-cut" data-next="5"><i class="fa-solid fa-scissors"></i><div class="btn-text">Option A: Cut the server's external network connection immediately to stop the data leak.<small>Stops the bleeding but takes the server completely offline.</small></div></button>
                                <button class="btn" data-decision="s4-honeypot" data-next="5"><i class="fa-solid fa-hat-cowboy-side"></i><div class="btn-text">Option B: Redirect the connection to a honeypot to deceive the attacker and see what they're stealing.<small>Provides valuable intel but is risky and time-consuming.</small></div></button>
                            </div>
                            <div class="learning-note"><strong>Learning Note:</strong> Modern ransomware attacks often use a "double extortion" tactic.</div>
                        </div>

                        <div id="finalSection" class="section centered-page" style="display: none;">
                            <h2><i class="fa-solid fa-chart-line"></i> Post-Crisis Assessment Report</h2>
                            <p>The simulation is complete. Below is a detailed breakdown of your crisis management performance.</p>
                            <div id="performance-badge-container"><span id="performance-badge"></span></div>
                            <div class="final-metrics" id="finalMetricsContainer"></div>
                            <div class="post-crisis-layout">
                                <div class="event-timeline">
                                    <h3><i class="fa-solid fa-timeline"></i> Decision Timeline</h3>
                                    <ul id="decision-timeline-list"></ul>
                                </div>
                                <div class="strategic-debrief">
                                    <h3><i class="fa-solid fa-lightbulb"></i> Strategic Debrief</h3>
                                    <div id="strategic-debrief-content"></div>
                                    <h3 style="margin-top: 20px;"><i class="fa-solid fa-calculator"></i> Score Breakdown</h3>
                                    <ul id="score-breakdown"></ul>
                                </div>
                            </div>
                            <div class="decision-buttons" style="margin-top: 40px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
                                <button class="btn btn-start" onclick="location.reload()"><i class="fa-solid fa-arrow-rotate-right"></i> Restart Simulation</button>
                                <button class="btn" id="openLeaderboardBtn"><i class="fa-solid fa-trophy"></i> Leaderboard</button>
                            </div>
                        </div>
                    `;
                    this.elements.gameContent.innerHTML = gameHTMLContent;
                    this.queryAndSetupDynamicElements();
                },

                queryAndSetupDynamicElements() {
                    this.elements.sections = this.elements.gameContent.querySelectorAll('.section');
                    this.elements.siemLogs2 = document.getElementById('siemLogs2');
                    this.elements.leaderboard.btnOpen = document.getElementById('openLeaderboardBtn');
                    this.elements.leaderboard.btnOpen?.addEventListener('click', () => this.openLeaderboard());
                    hljs.highlightAll();
                }
            };
            game.setup();
        });
    </script>
</body>
</html>
